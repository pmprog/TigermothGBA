
#include "stages.h"
#include "gba.h"
#include "maths.h"
#include "tilefaces_bin.h"
#include "vars.h"
#include "bullets.h"

#define GAMEOVER_DELAY_TIME     2

bool gameover_buttonspressed;

const u8 gameover_tilemap[] = {
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,4,10,24,5,1,4,11,3,1,6,1,1,4,6,1,6,14,5,1,1,1,1,1,1,1,1,1,1,1,
    1,6,1,1,1,1,6,1,17,1,20,2,3,5,6,1,19,3,1,1,1,1,1,1,1,1,1,1,1,1,
    1,21,1,2,5,1,6,4,22,1,6,1,2,1,19,1,23,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,18,1,1,19,1,18,1,5,1,2,1,1,1,21,1,6,9,5,1,1,1,1,1,1,1,1,1,1,1,
    1,2,31,13,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,4,6,13,3,1,19,1,1,6,1,6,45,5,1,6,12,6,1,1,
    1,1,1,1,1,1,1,1,1,1,1,19,1,1,3,1,6,1,1,21,1,21,3,1,1,22,1,1,31,1,
    1,1,1,1,1,1,1,1,1,1,1,6,1,1,19,1,2,3,4,5,1,18,1,1,1,20,15,10,1,1,
    1,1,1,1,1,1,1,1,1,1,1,20,1,1,6,1,1,2,5,1,1,6,12,5,1,5,1,1,6,1,
    1,1,1,1,1,1,1,1,1,1,1,2,31,6,42,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
};

const u8 gameover_colourmap[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,4,0,0,5,5,2,5,6,3,2,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,5,0,0,0,0,0,5,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,1,3,2,0,4,5,0,1,3,2,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,4,0,0,0,0,4,5,6,6,0,0,0,0,4,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,4,0,0,4,4,1,2,5,6,0,0,4,0,5,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,5,0,0,0,1,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,2,3,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,2,1,2,2,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,2,2,1,2,1,2,0,
    0,0,0,0,1,0,3,2,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,3,1,0,1,0,1,0,
    0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,
    0,0,1,1,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,6,5,2,0,
    0,0,0,0,0,0,0,0,0,1,2,2,0,1,1,0,2,0,0,2,0,0,0,0,0,2,0,0,0,2,
    0,5,0,4,0,1,1,2,0,0,0,0,5,0,2,0,5,6,1,2,0,1,0,2,0,1,0,1,0,2,
    0,6,0,0,0,0,0,1,0,0,1,0,4,1,2,0,5,5,4,0,0,5,0,6,0,1,0,0,0,6,
    0,4,0,5,0,4,0,6,0,0,0,0,4,0,5,0,1,0,0,0,0,4,0,5,0,0,0,4,4,5,
    0,4,0,1,0,4,4,5,0,4,5,4,4,0,6,0,0,0,0,1,0,0,2,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,4,0,0,0,0,0,0,0,0,0,7,7,7,7,7,0,7,0,0,0,0,0,0
};

const FullscreenInfo gameover_fsinfo = { tilefaces_bin, 8, 384, gameover_tilemap, gameover_colourmap, menu_palettes };

void gameover_update()
{

    if( stage_initialised == 0 )
    {
        gameover_buttonspressed = true;
        for(int idx = 0; idx < 12; idx++)
        {
            OAM[idx].attr0 |= OBJ_DISABLE;
        }
        InitBullets();
        frame_delay = GAMEOVER_DELAY_TIME;
        stage_initialised = 1;
    }

    if( gameover_buttonspressed )
    {
        if((keysHeld() & KEY_A) == 0 && (keysHeld() & KEY_B) == 0)
        {
            gameover_buttonspressed = false;
        }
    }

    frame_delay--;
    if(frame_delay >= 0) 
    {
        return;
    }

    BlitFullscreen(&gameover_fsinfo, FULLSCREEN_COLUMNS_ROWS);

    frame_time++;
    frame_time &= 0x00FF;
    frame_delay = GAMEOVER_DELAY_TIME;


    if(!gameover_buttonspressed && ((keysHeld() & KEY_A) != 0 || (keysHeld() & KEY_B) != 0))
    {
        SetStage(menu_update);
    }
}

